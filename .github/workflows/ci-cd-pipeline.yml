name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  config-policy:
    name: Config Policy Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enforce production config policies
        shell: bash
        run: |
          set -euo pipefail

          disallowed_ddl_files=(
            "account-service/src/main/resources/application-prod.properties"
            "transaction-service/src/main/resources/application-prod.properties"
            "infrastructure/helm/account-service/values-prod.yaml"
          )

          for f in "${disallowed_ddl_files[@]}"; do
            if [ -f "$f" ] && grep -E "ddl-auto=update" "$f" >/dev/null; then
              echo "Found disallowed ddl-auto=update in $f"
              exit 1
            fi
          done

          if grep -R \
              --exclude-dir=.git \
              --exclude-dir=target \
              --exclude-dir=src/test \
              --exclude='*.md' \
              --exclude='*.log' \
              "AY8Ro0HSBFyllm9ZPafT2GWuE/t8Yzq1P0Rf7bNeq14=" \
              account-service \
              transaction-service \
              infrastructure \
              docker-compose.yml \
              account-service/docker-compose.yml \
              transaction-service/docker-compose.yml >/dev/null; then
            echo "Found disallowed hardcoded JWT secret in repository"
            exit 1
          fi

  account-tests:
    name: Account Service Tests (Java ${{ matrix.java }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: ['21', '22']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: temurin
          cache: maven

      - name: Run account-service unit/integration tests
        working-directory: account-service
        run: ./mvnw -q test -DskipITs

  transaction-tests:
    name: Transaction Service Tests (Java ${{ matrix.java }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: ['21', '22']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: temurin
          cache: maven

      - name: Run transaction-service hardening tests
        working-directory: transaction-service
        run: ./mvnw -q -Dtest=TransactionServiceHardeningTest test

  dependency-scan:
    name: Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: temurin
          cache: maven

      - name: Scan account-service dependencies
        working-directory: account-service
        run: ./mvnw -q org.owasp:dependency-check-maven:check -DskipTests

      - name: Scan transaction-service dependencies
        working-directory: transaction-service
        run: ./mvnw -q org.owasp:dependency-check-maven:check -DskipTests

  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: false
