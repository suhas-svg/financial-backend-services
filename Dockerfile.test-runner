FROM openjdk:22-jdk-slim

# Install required tools
RUN apt-get update && apt-get install -y \
    curl \
    jq \
    postgresql-client \
    redis-tools \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy test scripts and configuration
COPY full-system-e2e-test.ps1 /app/
COPY test-results /app/test-results/

# Install PowerShell
RUN apt-get update && apt-get install -y wget apt-transport-https software-properties-common \
    && wget -q https://packages.microsoft.com/config/debian/11/packages-microsoft-prod.deb \
    && dpkg -i packages-microsoft-prod.deb \
    && apt-get update \
    && apt-get install -y powershell \
    && rm -rf /var/lib/apt/lists/*

# Copy JAR files for both services (these would be built beforehand)
COPY account-service/target/account-service-1.0.0.jar /app/account-service.jar
COPY transaction-service/target/transaction-service-1.0.0.jar /app/transaction-service.jar

# Create test script
RUN echo '#!/bin/bash\n\
echo "Starting Full System E2E Tests..."\n\
echo "Waiting for services to be ready..."\n\
sleep 30\n\
\n\
# Test service health\n\
echo "Testing Account Service health..."\n\
curl -f $ACCOUNT_SERVICE_URL/actuator/health || exit 1\n\
\n\
echo "Testing Transaction Service health..."\n\
curl -f $TRANSACTION_SERVICE_URL/actuator/health || exit 1\n\
\n\
# Run PowerShell test script\n\
echo "Running comprehensive E2E tests..."\n\
pwsh -File /app/full-system-e2e-test.ps1 -SkipBuild $true\n\
\n\
echo "E2E Tests completed!"\n\
' > /app/run-tests.sh

RUN chmod +x /app/run-tests.sh

# Health check script
RUN echo '#!/bin/bash\n\
curl -f $ACCOUNT_SERVICE_URL/actuator/health && \\\n\
curl -f $TRANSACTION_SERVICE_URL/actuator/health\n\
' > /app/health-check.sh

RUN chmod +x /app/health-check.sh

EXPOSE 8080

CMD ["/app/run-tests.sh"]